<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>×™×•×¦×¨ ××¤×•×ª ×™×©×™×‘×” ×œ×›×™×ª×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Heebo', sans-serif;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Print styles */
      @media print {
        @page {
          size: A4 landscape;
          margin: 8mm;
        }
        
        body * {
          visibility: hidden;
        }
        .print-hidden {
          display: none !important;
        }
        #printable-area, #printable-area * {
          visibility: visible;
        }
        #printable-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: white !important;
          padding: 6px !important;
          box-sizing: border-box !important;
        }
        
        .classroom-grid {
          width: 100% !important;
          height: auto !important;
          gap: 0px !important;
          grid-template-columns: auto 1fr 1fr 1fr 1fr !important;
          grid-template-rows: auto repeat(5, 1fr) !important;
          justify-items: stretch !important;
          align-items: stretch !important;
          max-width: 100% !important;
        }
        
        .desk-container {
          width: 100% !important;
          height: 120px !important;
          min-width: 0 !important;
          max-width: 170px !important;
        }
        
        .student-name {
          font-size: 14px !important;
          line-height: 1.3 !important;
        }
        
        .row-label {
          writing-mode: horizontal-tb !important;
          text-align: center !important;
          min-width: 50px !important;
          font-size: 12px !important;
        }
        
        .column-header {
          font-size: 12px !important;
        }
        
        .teacher-desk-area {
          margin-bottom: 8px !important;
          margin-top: 8px !important;
        }
        
        .teacher-desk-area > div {
          transform: scale(0.8) !important;
        }
        
        h1 {
          font-size: 24px !important;
          margin-bottom: 4px !important;
        }
        
        h2 {
          font-size: 16px !important;
          margin-bottom: 8px !important;
        }
        
        .student-picture {
          width: 30px !important;
          height: 30px !important;
        }
        
        .seat-number {
          font-size: 8px !important;
          padding: 1px 2px !important;
        }
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-700">
    <div id="root"></div>

<script type="module">
// =================================================================
//  IMPORTS & SETUP
// =================================================================
import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.11.0";

const root = document.getElementById('root');
const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

// ×”×’×“×¨×ª ××¤×ª×— API - ×× ×™×© ×œ×š ××¤×ª×— Gemini, ×”×—×œ×£ ×›××Ÿ
const API_KEY = "";  // ×”×©××¨ ×¨×™×§ ×œ×©×™××•×© ×™×“× ×™, ××• ×”×›× ×¡ ××¤×ª×— Gemini

// =================================================================
//  ICONS
// =================================================================
const DoorIcon = ({ className = '' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m8-10v10m-4-10v10M3 21h18M3 21V5a2 2 0 012-2h12a2 2 0 012 2v16M15 11a1 1 0 11-2 0 1 1 0 012 0z" /></svg>`;
const WindowIcon = ({ className = '' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16M6 4v16m12-16v16" /></svg>`;
const UserIcon = ({ className = '' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
const PlusIcon = ({ className = '' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`;
const TrashIcon = ({ className = 'h-5 w-5' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
const PencilIcon = ({ className = 'h-5 w-5' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>`;
const UndoIcon = ({ className = 'h-5 w-5' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8A5 5 0 009 5H7" /></svg>`;
const RedoIcon = ({ className = 'h-5 w-5' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 15l3-3m0 0l-3-3m3 3H8A5 5 0 003 9h2" /></svg>`;
const ShuffleIcon = ({ className = 'h-5 w-5' } = {}) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>`;

// =================================================================
//  STATE MANAGEMENT
// =================================================================
const DEFAULT_ROWS_LAYOUT = { rows: 5, cols: 4, teacherDeskPosition: 'top', windowPosition: 'left', doorPosition: 'right' };
const DEFAULT_GROUPS_LAYOUT = { groups: 4 };
const DEFAULT_STUDENT_CONSTRAINTS = { frontRow: 'neutral', lastRow: 'neutral', nearWindow: 'neutral', nearDoor: 'neutral', sitAlone: false, sitWith: [], dontSitWith: [], fixedPosition: null };

let state = {
    allUsers: [],
    currentUser: null,
    allCharts: {},
    currentScreen: 'main',
    studentToEdit: null,
    studentAddMode: 'single',
    studentListInput: '',
    isCreateModalOpen: false,
    isEmbedModalOpen: false,
    isEmbedView: false,
    openClass: null,
    history: [],
    pointer: -1,
};

function getActiveChart() {
    return state.history[state.pointer] || null;
}

function setActiveChart(updaterFn) {
    const currentChart = getActiveChart();
    const newChart = updaterFn(currentChart);

    if (JSON.stringify(newChart) === JSON.stringify(currentChart)) return;

    const newHistory = state.history.slice(0, state.pointer + 1);
    newHistory.push(JSON.parse(JSON.stringify(newChart))); // Deep copy for history
    state.history = newHistory;
    state.pointer = newHistory.length - 1;
}

function resetHistory(initialChart) {
    state.history = initialChart ? [JSON.parse(JSON.stringify(initialChart))] : [];
    state.pointer = initialChart ? 0 : -1;
}

function undo() {
    if (state.pointer > 0) {
        state.pointer--;
        renderApp();
    }
}

function redo() {
    if (state.pointer < state.history.length - 1) {
        state.pointer++;
        renderApp();
    }
}

function getFromLocalStorage(key, initialValue) {
    try {
        const item = window.localStorage.getItem(key);
        return item ? JSON.parse(item) : initialValue;
    } catch (error) {
        console.error(error);
        return initialValue;
    }
}

function saveToLocalStorage(key, value) {
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
        console.error(error);
    }
}

let ai;
try {
    if (API_KEY) {
        ai = new GoogleGenAI({ apiKey: API_KEY });
    }
} catch (e) {
    console.error("Failed to initialize GoogleGenAI:", e);
}

// Add global function for layout selection
window.selectLayoutType = function(type) {
    console.log("Layout type selected:", type);
    setActiveChart(prev => ({
        ...prev,
        layoutType: type,
        layoutDetails: type === 'rows' ? {...DEFAULT_ROWS_LAYOUT} : {...DEFAULT_GROUPS_LAYOUT}
    }));
    renderApp();
};

// Manual layout generation (fallback when no API key)
function generateManualLayout(chart) {
    console.log("generateManualLayout called for:", chart.layoutType);
    if (chart.layoutType === 'rows') {
        console.log("Generating rows layout");
        return generateManualRowsLayout(chart);
    } else {
        console.log("Generating groups layout");
        return generateManualGroupsLayout(chart);
    }
}

function generateManualRowsLayout(chart) {
    const { rows, cols } = chart.layoutDetails;
    const students = [...chart.students];
    const desks = [];
    const unplacedStudents = [];
    
    // Initialize all desks first
    for (let row = 1; row <= rows; row++) {
        for (let col = 1; col <= cols; col++) {
            desks.push({ row, col, students: [] });
        }
    }
    
    // Separate fixed and non-fixed students
    const fixedStudents = students.filter(s => s.constraints && s.constraints.fixedPosition);
    const nonFixedStudents = students.filter(s => !s.constraints || !s.constraints.fixedPosition);
    
    // Place students with fixed positions FIRST
    fixedStudents.forEach(student => {
        const fixedPos = student.constraints.fixedPosition;
        const targetDesk = desks.find(d => d.row === fixedPos.row && d.col === fixedPos.col);
        
        if (targetDesk) {
            // Remove any student already in this exact seat
            targetDesk.students = targetDesk.students.filter(s => s.seat !== fixedPos.seat);
            // Place the student in the exact seat
            targetDesk.students.push({
                name: student.name,
                seat: fixedPos.seat
            });
        }
    });
    
    // Shuffle non-fixed students for RANDOM placement (this is the key!)
    const shuffledNonFixed = [...nonFixedStudents];
    for (let i = shuffledNonFixed.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledNonFixed[i], shuffledNonFixed[j]] = [shuffledNonFixed[j], shuffledNonFixed[i]];
    }
    
    // Now place shuffled non-fixed students in remaining seats
    let studentIndex = 0;
    for (let row = 1; row <= rows && studentIndex < shuffledNonFixed.length; row++) {
        for (let col = 1; col <= cols && studentIndex < shuffledNonFixed.length; col++) {
            const desk = desks.find(d => d.row === row && d.col === col);
            
            // Try to fill each seat (1 and 2) if not occupied
            for (let seat = 1; seat <= 2 && studentIndex < shuffledNonFixed.length; seat++) {
                const seatOccupied = desk.students.some(s => s.seat === seat);
                if (!seatOccupied) {
                    desk.students.push({
                        name: shuffledNonFixed[studentIndex].name,
                        seat: seat
                    });
                    studentIndex++;
                }
            }
        }
    }
    
    // Add any remaining students to unplaced list
    while (studentIndex < shuffledNonFixed.length) {
        unplacedStudents.push(shuffledNonFixed[studentIndex].name);
        studentIndex++;
    }
    
    return { desks, unplacedStudents };
}

function generateManualGroupsLayout(chart) {
    console.log("generateManualGroupsLayout called with:", chart);
    
    const { groups: numGroups } = chart.layoutDetails;
    console.log("Number of groups:", numGroups);
    
    const students = [...chart.students];
    console.log("Students:", students);
    
    const groups = [];
    const unplacedStudents = [];
    
    // Initialize groups
    for (let i = 1; i <= numGroups; i++) {
        groups.push({ groupNumber: i, students: [] });
    }
    
    console.log("Initialized groups:", groups);
    
    // Handle students with constraints first
    const studentsWithConstraints = [];
    const studentsWithoutConstraints = [];
    
    students.forEach(student => {
        const hasConstraints = 
            student.constraints.sitWith.length > 0 || 
            student.constraints.dontSitWith.length > 0;
        
        if (hasConstraints) {
            studentsWithConstraints.push(student);
        } else {
            studentsWithoutConstraints.push(student);
        }
    });
    
    console.log("Students with constraints:", studentsWithConstraints);
    console.log("Students without constraints:", studentsWithoutConstraints);
    
    // Track placed students
    const placedStudents = new Set();
    
    // First, handle "sitWith" constraints
    studentsWithConstraints.forEach(student => {
        if (placedStudents.has(student.name)) return;
        
        if (student.constraints.sitWith.length > 0) {
            // Find names of students they want to sit with
            const wantToSitWith = student.constraints.sitWith
                .map(id => students.find(s => s.id === id)?.name)
                .filter(name => name && !placedStudents.has(name));
            
            if (wantToSitWith.length > 0) {
                // Find the group with most space
                const targetGroup = groups.reduce((min, group) => 
                    group.students.length < min.students.length ? group : min
                );
                
                // Add student and their preferred partners
                targetGroup.students.push(student.name);
                placedStudents.add(student.name);
                
                wantToSitWith.forEach(name => {
                    if (!placedStudents.has(name)) {
                        targetGroup.students.push(name);
                        placedStudents.add(name);
                    }
                });
                
                console.log(`Placed ${student.name} with ${wantToSitWith.join(', ')} in group ${targetGroup.groupNumber}`);
            }
        }
    });
    
    // Then handle remaining students with constraints but no "sitWith"
    studentsWithConstraints.forEach(student => {
        if (placedStudents.has(student.name)) return;
        
        // Find names of students they DON'T want to sit with
        const dontSitWith = student.constraints.dontSitWith
            .map(id => students.find(s => s.id === id)?.name)
            .filter(name => name);
        
        // Find a group that doesn't contain any of the "don't sit with" students
        let targetGroup = null;
        for (const group of groups) {
            const hasConflict = group.students.some(name => dontSitWith.includes(name));
            if (!hasConflict) {
                if (!targetGroup || group.students.length < targetGroup.students.length) {
                    targetGroup = group;
                }
            }
        }
        
        if (targetGroup) {
            targetGroup.students.push(student.name);
            placedStudents.add(student.name);
            console.log(`Placed ${student.name} in group ${targetGroup.groupNumber} (avoiding conflicts)`);
        } else {
            // If no group works, add to unplaced
            unplacedStudents.push(student.name);
            console.log(`Could not place ${student.name} due to constraints`);
        }
    });
    
    // Finally, distribute remaining students randomly
    const remainingStudents = [...studentsWithoutConstraints, ...studentsWithConstraints]
        .filter(student => !placedStudents.has(student.name));
    
    // Shuffle remaining students
    for (let i = remainingStudents.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [remainingStudents[i], remainingStudents[j]] = [remainingStudents[j], remainingStudents[i]];
    }
    
    // Distribute remaining students evenly
    remainingStudents.forEach((student, index) => {
        const groupIndex = index % numGroups;
        groups[groupIndex].students.push(student.name);
        console.log(`Added ${student.name} to group ${groupIndex + 1}`);
    });
    
    console.log("Final groups result:", { groups, unplacedStudents });
    return { groups, unplacedStudents };
}

const getStudentNameById = (id, students) => {
    return students.find(s => s.id === id)?.name || '';
}

const generateSeatingChartPrompt = (chart) => {
  const studentsPromptData = chart.students.map(s => ({
    name: s.name,
    constraints: {
      ...s.constraints,
      sitWith: s.constraints.sitWith.map(id => getStudentNameById(id, chart.students)).filter(Boolean),
      dontSitWith: s.constraints.dontSitWith.map(id => getStudentNameById(id, chart.students)).filter(Boolean),
    }
  }));

  let layoutSpecificPrompt;
  if (chart.layoutType === 'rows') {
    const layoutDetails = chart.layoutDetails;
    layoutSpecificPrompt = `The classroom layout is ${layoutDetails.rows} rows and ${layoutDetails.cols} columns. 
    The teacher's desk is at the '${layoutDetails.teacherDeskPosition}'.
    Positional references:
    - The window is on the '${layoutDetails.windowPosition}' side.
    - The door is on the '${layoutDetails.doorPosition}' side.
    - 'Right' and 'left' are fixed from a top-down view.
    - 'Row 1' is always the row closest to the teacher's desk. 'Row ${layoutDetails.rows}' is the farthest.
    Each student desk has 2 seats.`;
  } else {
    const layoutDetails = chart.layoutDetails;
    layoutSpecificPrompt = `Divide the students into ${layoutDetails.groups} groups.`;
  }

  const prompt = `
    You are a classroom organization expert. Create an optimal seating chart or group arrangement based on the following data.
    Fulfill as many constraints as possible, prioritizing hard constraints ('must', 'must_not', 'sitAlone', 'fixedPosition') over preferences.
    For row layouts, the 'fixedPosition' constraint is the highest priority. Place the student exactly as specified. If two students are fixed to the same spot, place the first one and leave the other unplaced.

    Arrangement Type: ${chart.layoutType === 'rows' ? 'Rows and Columns' : 'Groups'}
    ${layoutSpecificPrompt}
    Student List and Constraints:
    ${JSON.stringify(studentsPromptData, null, 2)}

    Return the output in JSON format only, according to the provided schema.
    Place each student only once. If a student cannot be placed, add them to the unplaced list.
    For row layouts, use 1-based indexing (Row 1, Col 1).
    For each student at a desk, you must specify their seat number: 1 for the left seat and 2 for the right seat.
    For the "sit alone" constraint, place the student by themselves at a two-seat desk.
    `;
    return prompt;
};

const rowsSchema = { type: Type.OBJECT, properties: { desks: { type: Type.ARRAY, description: "An array representing all student desks in the classroom.", items: { type: Type.OBJECT, properties: { row: { type: Type.INTEGER, description: "The row number of the desk (1-based)." }, col: { type: Type.INTEGER, description: "The column number of the desk (1-based)." }, students: { type: Type.ARRAY, description: "An array of student objects sitting at this desk (max 2). Each object specifies the student's name and their seat number (1 for left, 2 for right).", items: { type: Type.OBJECT, properties: { name: { type: Type.STRING, description: "The student's name." }, seat: { type: Type.INTEGER, description: "The seat number at the desk (1 for left, 2 for right)." } }, required: ["name", "seat"] } } }, required: ["row", "col", "students"] } }, unplacedStudents: { type: Type.ARRAY, description: "A list of student names that could not be placed.", items: { type: Type.STRING } } }, required: ["desks", "unplacedStudents"] };
const groupsSchema = { type: Type.OBJECT, properties: { groups: { type: Type.ARRAY, description: "An array of groups with students.", items: { type: Type.OBJECT, properties: { groupNumber: { type: Type.INTEGER, description: "The group number (1-based)." }, students: { type: Type.ARRAY, description: "An array of student names in this group.", items: { type: Type.STRING } } }, required: ["groupNumber", "students"] } }, unplacedStudents: { type: Type.ARRAY, description: "A list of student names that could not be placed.", items: { type: Type.STRING } } }, required: ["groups", "unplacedStudents"] };

async function generateLayout(chart) {
  console.log("generateLayout called with:", chart);
  
  // If no API key, use manual generation
  if (!API_KEY || !ai) {
    console.log("Using manual generation (no API key)");
    return generateManualLayout(chart);
  }
  
  const prompt = generateSeatingChartPrompt(chart);
  const schema = chart.layoutType === 'rows' ? rowsSchema : groupsSchema;

  try {
    console.log("Trying to use Gemini AI...");
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: schema,
        temperature: 0.5,
      },
    });

    const text = response.text.trim();
    return JSON.parse(text);

  } catch (error) {
    console.error("Error generating layout with Gemini:", error);
    console.log("Falling back to manual generation");
    // Fallback to manual generation
    return generateManualLayout(chart);
  }
}

// =================================================================
//  HTML RENDER FUNCTIONS
// =================================================================

function AppShell(headerHTML, contentHTML) {
    return `
        <div class="min-h-screen bg-slate-50 relative">
            <header id="header-area" class="print-hidden">${headerHTML}</header>
            <main id="content-area" class="min-h-screen w-full h-full p-4 sm:p-8 flex items-center justify-center ${headerHTML ? 'pt-24' : ''}">
                ${contentHTML}
            </main>
        </div>
    `;
}

function LoginScreen() {
    return `
    <div class="min-h-screen bg-gradient-to-br from-sky-100 to-teal-100 relative">
        <div class="min-h-screen w-full h-full p-4 sm:p-8 flex items-center justify-center">
            <div class="w-full max-w-md mx-auto">
                <div class="bg-white/60 backdrop-blur-md rounded-xl shadow-2xl p-8">
                    <h1 class="text-3xl font-bold text-center text-sky-800 mb-2">×™×•×¦×¨ ××¤×•×ª ×™×©×™×‘×”</h1>
                    <p class="text-center text-slate-600 mb-6">×”×ª×—×‘×¨ ××• ×¦×•×¨ ×¤×¨×•×¤×™×œ ×—×“×© ×›×“×™ ×œ×”×ª×—×™×œ.</p>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="teacherName" class="block text-sm font-medium text-slate-700">×©× ×”××•×¨×”</label>
                            <input
                                id="teacherName"
                                type="text"
                                placeholder="×”×§×œ×“ ××ª ×©××š..."
                                class="mt-1 w-full p-3 border rounded-md"
                                required
                            />
                        </div>
                        <button type="submit" class="w-full py-3 px-4 bg-sky-500 text-white font-bold rounded-md hover:bg-sky-600 transition duration-300">
                            ×”×ª×—×‘×¨
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>`;
}

function MainHeader() {
    return `<div class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-sm p-3 flex justify-between items-center z-30">
           <div>
               <h1 class="text-xl font-bold text-slate-800">×™×•×¦×¨ ××¤×•×ª ×™×©×™×‘×”</h1>
               <p class="text-sm text-slate-500">××—×•×‘×¨/×ª ×›: ${state.currentUser}</p>
           </div>
           <button id="logout-btn" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-md">
               ×”×—×œ×£ ××©×ª××©
           </button>
       </div>`;
}

function EditorHeader() {
    const canUndo = state.pointer > 0;
    const canRedo = state.pointer < state.history.length - 1;
    const activeChart = getActiveChart();

    return `<div class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-md p-2 flex justify-between items-center z-30 print-hidden">
        <div class="flex items-center space-x-2 space-x-reverse">
            <button id="save-and-exit-btn" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 text-sm">
                ×—×–×¨×” ×œ×¨×©×™××”
            </button>
        </div>
        
        <div class="flex-grow flex justify-center items-center space-x-2 space-x-reverse">
             ${state.currentScreen === 'result' ? `
                <button data-screen="setup" class="screen-nav-btn text-sm bg-violet-400 text-white font-semibold hover:bg-violet-500 p-2 rounded-md">×¢×¨×™×›×ª ×”×’×“×¨×•×ª</button>
                <button data-screen="students" class="screen-nav-btn text-sm bg-rose-400 text-white font-semibold hover:bg-rose-500 p-2 rounded-md">×¢×¨×™×›×ª ×ª×œ××™×“×™×</button>
                <button id="regenerate-btn" class="text-sm bg-orange-500 text-white font-semibold hover:bg-orange-600 p-2 rounded-md flex items-center space-x-1 space-x-reverse">
                    ${ShuffleIcon({className: 'h-4 w-4'})} <span>×™×¦×™×¨×” ××—×“×©</span>
                </button>
                <button id="print-btn" class="text-sm bg-slate-600 text-white font-semibold hover:bg-slate-700 p-2 rounded-md flex items-center space-x-1 space-x-reverse">
                    ğŸ–¨ï¸ <span>×”×“×¤×¡</span>
                </button>
             ` : ''}
        </div>

        <div class="flex items-center space-x-2 space-x-reverse">
             <button id="redo-btn" ${!canRedo ? 'disabled' : ''} title="×‘×¦×¢ ×©×•×‘" class="p-2 bg-slate-100 rounded-full text-slate-700 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">
                ${RedoIcon()}
            </button>
            <button id="undo-btn" ${!canUndo ? 'disabled' : ''} title="×‘×˜×œ" class="p-2 bg-slate-100 rounded-full text-slate-700 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">
                ${UndoIcon()}
            </button>
        </div>
    </div>`;
}

function MainScreen() {
    const charts = state.allCharts[state.currentUser] || [];
    const groupedCharts = charts.reduce((acc, chart) => {
        const key = chart.className || '×œ×œ× ×©× ×›×™×ª×”';
        if (!acc[key]) acc[key] = [];
        acc[key].push(chart);
        acc[key].sort((a,b) => new Date(b.creationDate).getTime() - new Date(a.creationDate).getTime());
        return acc;
    }, {});

    const chartsHTML = Object.entries(groupedCharts).map(([className, classCharts]) => `
         <div key="${className}" class="border rounded-lg overflow-hidden">
            <div class="w-full flex justify-between items-center p-4 bg-teal-50 hover:bg-teal-100">
                <button data-classname="${className}" class="toggle-class-btn flex items-center space-x-3 space-x-reverse flex-grow">
                    <span class="font-bold text-xl text-teal-800">${className}</span>
                    <svg class="w-6 h-6 transition-transform ${state.openClass === className ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <button data-classname="${className}" class="delete-class-btn text-rose-500 hover:text-rose-700 p-2 rounded ml-2" title="××—×§ ×›×™×ª×” ×©×œ××”">
                    ${TrashIcon({className: 'h-5 w-5'})}
                </button>
            </div>
            ${state.openClass === className ? `
                <div class="p-4 space-y-2">
                    ${classCharts.map(chart => `
                        <div key="${chart.id}" class="flex justify-between items-center p-2 rounded-md hover:bg-slate-50">
                            <div>
                               <span class="font-medium text-slate-800">${new Date(chart.creationDate).toLocaleDateString('he-IL', {timeZone: 'UTC'})}</span>
                            </div>
                            <div>
                                <button data-id="${chart.id}" class="load-chart-btn text-sky-600 hover:text-sky-800 font-semibold ml-4">×˜×¢×Ÿ</button>
                                <button data-id="${chart.id}" class="delete-chart-btn text-rose-500 hover:text-rose-700 font-semibold">${TrashIcon({className: 'inline h-4 w-4'})}</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `).join('');
    
    return `
        <div id="main-screen-container" class="w-full max-w-4xl text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-800 mb-4">×”×›×™×ª×•×ª ×©×œ×™</h1>
            <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto">×”×ª×—×œ ×‘×™×¦×™×¨×ª ××¤×” ×—×“×©×” ××• ×˜×¢×Ÿ ××¤×” ×§×™×™××ª ×××—×ª ×”×›×™×ª×•×ª ×©×œ×š.</p>
            
            <div class="mb-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4 max-w-2xl mx-auto">
                <p class="text-emerald-800 text-sm">
                    <strong>âœ… ×”×“×¤×¡×” ×¤×©×•×˜×”:</strong> ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×”×“×¤×¡" ×›×“×™ ×œ×”×“×¤×™×¡ ××• ×œ×©××•×¨ ×›-PDF ×™×©×™×¨×•×ª ××”×“×¤×“×¤×Ÿ.
                </p>
            </div>
            
            <button id="start-new-chart-btn" class="bg-sky-500 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-sky-600 transition duration-300 shadow-lg">
                ×”×ª×—×œ ××¤×” ×—×“×©×”
            </button>
            ${charts.length > 0 ? `
                <div class="mt-12">
                    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-4 space-y-3 text-right">
                        ${chartsHTML}
                    </div>
                </div>
            ` : `
                 <div class="mt-8 bg-amber-50 border-r-4 border-amber-400 p-4 rounded-md max-w-2xl mx-auto">
                    <p class="text-amber-800">×¢×“×™×™×Ÿ ×œ× ×™×¦×¨×ª ××¤×•×ª. ×œ×—×¥ ×¢×œ "×”×ª×—×œ ××¤×” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ.</p>
                </div>
            `}
        </div>
    `;
}

function CreateChartModal() {
    if (!state.isCreateModalOpen) return '';

    return `
        <div id="create-chart-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">×™×¦×™×¨×ª ××¤×” ×—×“×©×”</h2>
                <form id="create-chart-form" class="space-y-4">
                    <div>
                        <label for="className" class="block text-sm font-medium text-slate-700 mb-1">×©× ×”×›×™×ª×”</label>
                        <input
                            id="className"
                            type="text"
                            placeholder="×œ×“×•×’××”: ×›×™×ª×” ×”'1"
                            class="w-full p-2 border rounded-md"
                            required
                        />
                    </div>
                    <div>
                        <label for="chartDate" class="block text-sm font-medium text-slate-700 mb-1">×ª××¨×™×š ×”××¤×”</label>
                         <input
                            id="chartDate"
                            type="date"
                            value="${new Date().toISOString().split('T')[0]}"
                            class="w-full p-2 border rounded-md"
                            required
                        />
                    </div>
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="close-modal-btn" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">×‘×™×˜×•×œ</button>
                        <button type="submit" class="py-2 px-4 bg-sky-500 text-white rounded-md hover:bg-sky-600">×¦×•×¨ ××¤×”</button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function SetupScreen() {
    const activeChart = getActiveChart();
    if (!activeChart) return `<p>×˜×•×¢×Ÿ...</p>`;
    
    console.log("SetupScreen - activeChart.layoutType:", activeChart.layoutType);
    
    const isRows = activeChart.layoutType === 'rows';
    const layoutDetails = activeChart.layoutDetails;

    return `<div id="setup-screen-container" class="w-full max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">×©×œ×‘ 1: ×”×’×“×¨×•×ª ×”××¤×”</h2>
        <p class="text-center text-slate-500 mb-6">×›×™×ª×”: <span class="font-semibold">${activeChart.className}</span></p>
        <div class="bg-white p-8 rounded-lg shadow-xl space-y-8">
            <div>
                <label class="text-lg font-semibold text-slate-700 block mb-2">×ª××¨×™×š ×”××¤×”</label>
                <input type="date" data-key="creationDate" value="${activeChart.creationDate.split('T')[0]}" class="chart-update-input w-full p-3 border rounded-md" />
            </div>
            <div>
                <label class="text-lg font-semibold text-slate-700 block mb-2">×¡×•×’ ×¡×™×“×•×¨</label>
                <div class="flex space-x-4 space-x-reverse">
                    <button onclick="window.selectLayoutType('rows')" class="flex-1 py-3 rounded-md text-lg font-bold transition-all ${isRows ? 'bg-sky-500 text-white shadow-lg' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}">×©×•×¨×•×ª ×•×˜×•×¨×™×</button>
                    <button onclick="window.selectLayoutType('groups')" class="flex-1 py-3 rounded-md text-lg font-bold transition-all ${!isRows ? 'bg-sky-500 text-white shadow-lg' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}">×§×‘×•×¦×•×ª</button>
                </div>
            </div>
            
            ${isRows ? `
            <div class="space-y-6 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div> <label class="font-medium text-slate-600">××¡×¤×¨ ×©×•×¨×•×ª</label> <input type="number" data-key="rows" value="${layoutDetails.rows}" min="1" class="layout-details-input w-full mt-1 p-2 border rounded-md"/> </div>
                    <div> <label class="font-medium text-slate-600">××¡×¤×¨ ×˜×•×¨×™×</label> <input type="number" data-key="cols" value="${layoutDetails.cols}" min="1" class="layout-details-input w-full mt-1 p-2 border rounded-md"/> </div>
                    <div> <label class="font-medium text-slate-600">××™×§×•× ×©×•×œ×—×Ÿ ××•×¨×”</label> <select data-key="teacherDeskPosition" class="layout-details-input w-full mt-1 p-2 border rounded-md"> <option value="top" ${layoutDetails.teacherDeskPosition === 'top' ? 'selected' : ''}>×œ××¢×œ×”</option> <option value="bottom" ${layoutDetails.teacherDeskPosition === 'bottom' ? 'selected' : ''}>×œ××˜×”</option> </select> </div>
                    <div> <label class="font-medium text-slate-600">××™×§×•× ×—×œ×•× ×•×ª</label> <select data-key="windowPosition" class="layout-details-input w-full mt-1 p-2 border rounded-md"> <option value="left" ${layoutDetails.windowPosition === 'left' ? 'selected' : ''}>×©×××œ</option> <option value="right" ${layoutDetails.windowPosition === 'right' ? 'selected' : ''}>×™××™×Ÿ</option> </select> </div>
                    <div> <label class="font-medium text-slate-600">××™×§×•× ×”×“×œ×ª</label> <select data-key="doorPosition" class="layout-details-input w-full mt-1 p-2 border rounded-md"> <option value="left" ${layoutDetails.doorPosition === 'left' ? 'selected' : ''}>×©×××œ</option> <option value="right" ${layoutDetails.doorPosition === 'right' ? 'selected' : ''}>×™××™×Ÿ</option> </select> </div>
                </div>
            </div>` : `
            <div class="animate-fade-in">
                <label class="font-medium text-slate-600">××¡×¤×¨ ×§×‘×•×¦×•×ª</label>
                <input type="number" data-key="groups" value="${layoutDetails.groups || 4}" min="2" class="layout-details-input w-full mt-1 p-2 border rounded-md"/>
            </div>`}

            <div class="flex justify-between pt-4">
                <button data-screen="main" class="screen-nav-btn py-2 px-6 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">×—×–×¨×”</button>
                <button data-screen="students" class="screen-nav-btn py-2 px-6 bg-sky-500 text-white rounded-md hover:bg-sky-600">×”×‘×</button>
            </div>
        </div>
    </div>`;
}

function StudentScreen() {
    const activeChart = getActiveChart();
    if (!activeChart) return `<p>×˜×•×¢×Ÿ...</p>`;

    console.log("StudentScreen - activeChart.layoutType:", activeChart.layoutType);

    return `
    <div id="student-screen-container" class="w-full max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">×©×œ×‘ 2: ×”×•×¡×¤×ª ×ª×œ××™×“×™× ×•×”×’×“×¨×ª ××™×œ×•×¦×™×</h2>
        <div class="bg-white p-8 rounded-lg shadow-xl">
            <div class="mb-6">
                <div class="flex border-b mb-4">
                    <button data-mode="single" class="add-mode-btn py-2 px-4 font-semibold ${state.studentAddMode === 'single' ? 'border-b-2 border-teal-500 text-teal-600' : 'text-slate-500 hover:text-slate-700'}">×”×•×¡×¤×ª ×ª×œ××™×“ ×‘×•×“×“</button>
                    <button data-mode="list" class="add-mode-btn py-2 px-4 font-semibold ${state.studentAddMode === 'list' ? 'border-b-2 border-teal-500 text-teal-600' : 'text-slate-500 hover:text-slate-700'}">×”×•×¡×¤×” ××¨×©×™××”</button>
                </div>
                ${state.studentAddMode === 'single' ? `
                    <form id="add-student-form" class="flex">
                        <input type="text" name="studentName" placeholder="×”×›× ×¡ ×©× ×ª×œ××™×“/×”" class="flex-grow p-3 border rounded-r-md" />
                        <button type="submit" class="bg-teal-500 text-white p-3 rounded-l-md hover:bg-teal-600 flex items-center">
                            ${PlusIcon({})} <span class="mr-2">×”×•×¡×£</span>
                        </button>
                    </form>
                ` : `
                    <form id="add-student-list-form">
                        <textarea id="student-list-input" placeholder="×”×“×‘×™×§×• ×¨×©×™××ª ×ª×œ××™×“×™× ×›××Ÿ, ×›×œ ×©× ×‘×©×•×¨×” ×—×“×©×”." class="w-full p-3 border rounded-md h-40 mb-3" .value="${state.studentListInput}"></textarea>
                        <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-md hover:bg-teal-600 flex items-center justify-center">
                            ${PlusIcon({})} <span class="mr-2">×”×•×¡×£ ×¨×©×™××”</span>
                        </button>
                    </form>
                `}
            </div>
            <div id="student-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                ${activeChart.students.map(student => `
                    <div key="${student.id}" class="flex items-center justify-between p-3 bg-slate-50 rounded-md shadow-sm">
                        <div class="flex items-center">
                            ${student.picture ? `<img src="${student.picture}" alt="${student.name}" class="w-10 h-10 rounded-full object-cover mr-4" />` : `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-4 flex-shrink-0">${UserIcon({className: 'w-6 h-6 text-slate-400'})}</div>`}
                            <span class="font-medium text-slate-800">${student.name}</span>
                        </div>
                        <div>
                            <button data-id="${student.id}" class="edit-student-btn p-2 text-sky-600 hover:text-sky-800">${PencilIcon({})}</button>
                            <button data-id="${student.id}" class="remove-student-btn p-2 text-rose-500 hover:text-rose-700">${TrashIcon({})}</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="flex justify-between mt-8">
                <button data-screen="setup" class="screen-nav-btn py-2 px-6 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">×”×§×•×“×</button>
                <button id="generate-chart-btn" class="py-2 px-6 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 font-bold">
                    ${activeChart.layoutType === 'groups' ? '×¦×•×¨ ×§×‘×•×¦×•×ª' : '×¦×•×¨ ××¤×ª ×›×™×ª×”'}
                </button>
            </div>
        </div>
    </div>`;
}

function StudentModal() {
    const student = state.studentToEdit;
    if (!student) return '';
    const activeChart = getActiveChart();
    const otherStudents = activeChart.students.filter(s => s.id !== student.id);
    const isRowsLayout = activeChart.layoutType === 'rows';
    const rowsLayoutDetails = isRowsLayout ? activeChart.layoutDetails : null;

    return `
    <div id="student-modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">×¢×¨×™×›×ª ×¤×¨×˜×™ ×ª×œ××™×“/×”: ${student.name}</h2>
            
            <div class="flex flex-col items-center mb-6">
                ${student.picture ? `<img src="${student.picture}" alt="${student.name}" class="w-24 h-24 rounded-full object-cover mb-2 ring-2 ring-sky-400" />` : `<div class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center mb-2 ring-2 ring-gray-300">${UserIcon({className: 'w-12 h-12 text-gray-500'})}</div>`}
                <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-md text-sm">
                    ×”×¢×œ××ª ×ª××•× ×”
                    <input id="picture-upload" type="file" class="hidden" accept="image/*" />
                </label>
            </div>

            <div id="student-constraints-form" class="space-y-6">
                
                ${isRowsLayout ? `
                    <!-- ××™×œ×•×¦×™× ××œ××™× ×¢×‘×•×¨ ×©×•×¨×•×ª ×•×˜×•×¨×™× -->
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-teal-600">××™×œ×•×¦×™ ××™×§×•×</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${['frontRow', 'lastRow', 'nearWindow', 'nearDoor'].map(key => `
                            <div class="bg-slate-50 p-3 rounded-md">
                                <label class="font-medium text-slate-600">${{frontRow: '×©×•×¨×” ×¨××©×•× ×”', lastRow: '×©×•×¨×” ××—×¨×•× ×”', nearWindow: '×œ×™×“ ×”×—×œ×•×Ÿ', nearDoor: '×œ×™×“ ×”×“×œ×ª'}[key]}</label>
                                <select data-key="${key}" class="constraint-input w-full mt-1 p-2 border rounded-md" ${student.constraints.fixedPosition ? 'disabled' : ''}>
                                    <option value="neutral" ${student.constraints[key] === 'neutral' ? 'selected' : ''}>×œ×œ× ×”×¢×“×¤×”</option>
                                    <option value="must" ${student.constraints[key] === 'must' ? 'selected' : ''}>×—×™×™×‘</option>
                                    <option value="must_not" ${student.constraints[key] === 'must_not' ? 'selected' : ''}>×œ× ×—×™×™×‘</option>
                                </select>
                            </div>`).join('')}
                             <div class="flex items-center bg-slate-50 p-3 rounded-md md:col-span-2">
                                <input type="checkbox" data-key="sitAlone" id="sitAlone" ${student.constraints.sitAlone ? 'checked' : ''} class="constraint-input h-5 w-5 text-sky-600 rounded" />
                                <label for="sitAlone" class="mr-2 font-medium text-slate-600">×—×™×™×‘ ×œ×©×‘×ª ×œ×‘×“</label>
                            </div>
                        </div>
                    </div>
                     
                    ${rowsLayoutDetails ? `
                        <div class="bg-amber-50 p-4 rounded-md">
                            <h3 class="font-bold text-lg mb-3 text-teal-600">××™×§×•× ×§×‘×•×¢ (×©×•×¨×•×ª ×‘×œ×‘×“)</h3>
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="fixed-position-toggle" ${student.constraints.fixedPosition ? 'checked' : ''} class="h-5 w-5 text-sky-600 rounded" />
                                <label for="fixed-position-toggle" class="mr-2 font-medium text-slate-600">×§×‘×¢ ××™×§×•× ××“×•×™×§ (×™×‘×˜×œ ××™×œ×•×¦×™ ××™×§×•× ××—×¨×™×)</label>
                            </div>
                            ${student.constraints.fixedPosition ? `
                                <div class="grid grid-cols-3 gap-3 animate-fade-in">
                                    <div><label class="text-sm font-medium">×©×•×¨×”</label><input type="number" data-key="row" min="1" max="${rowsLayoutDetails.rows}" value="${student.constraints.fixedPosition.row}" class="fixed-pos-input w-full mt-1 p-2 border rounded-md"/></div>
                                    <div><label class="text-sm font-medium">×˜×•×¨</label><input type="number" data-key="col" min="1" max="${rowsLayoutDetails.cols}" value="${student.constraints.fixedPosition.col}" class="fixed-pos-input w-full mt-1 p-2 border rounded-md"/></div>
                                    <div><label class="text-sm font-medium">×›×™×¡×</label><select data-key="seat" class="fixed-pos-input w-full mt-1 p-2 border rounded-md">
                                        <option value="1" ${student.constraints.fixedPosition.seat == 1 ? 'selected' : ''}>1 (×™××™×Ÿ)</option>
                                        <option value="2" ${student.constraints.fixedPosition.seat == 2 ? 'selected' : ''}>2 (×©×××œ)</option>
                                    </select></div>
                                </div>` : ''}
                        </div>` : ''}
                ` : `
                    <!-- ××™×œ×•×¦×™× ×¤×©×•×˜×™× ×¢×‘×•×¨ ×§×‘×•×¦×•×ª -->
                    <div class="bg-blue-50 p-4 rounded-md">
                        <h3 class="font-bold text-lg mb-3 text-teal-600">××™×œ×•×¦×™ ×§×‘×•×¦×•×ª</h3>
                        <p class="text-sm text-slate-600 mb-4">×”×’×“×¨ ××™×œ×•×¦×™× ×œ×—×œ×•×§×” ×œ×§×‘×•×¦×•×ª</p>
                    </div>
                `}

                <div>
                    <h3 class="font-bold text-lg mb-2 text-teal-600">××™×œ×•×¦×™× ×—×‘×¨×ª×™×™×</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-3 rounded-md">
                            <label class="font-medium text-slate-600 block mb-2">${isRowsLayout ? '××•××œ×¥ ×œ×©×‘×ª ×œ×™×“' : '×—×©×•×‘ ×œ×”×™×•×ª ×‘×§×‘×•×¦×” ×¢×'}</label>
                            <div class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                                ${otherStudents.map(s => `
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" value="${s.id}" ${student.constraints.sitWith.includes(s.id) ? 'checked' : ''} 
                                               class="constraint-checkbox mr-2" data-key="sitWith" />
                                        <span>${s.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <p class="text-xs text-slate-500 mt-1">× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×ª×œ××™×“×™×</p>
                        </div>
                         <div class="bg-indigo-50 p-3 rounded-md">
                            <label class="font-medium text-slate-600 block mb-2">${isRowsLayout ? '×œ× ××•××œ×¥ ×œ×©×‘×ª ×œ×™×“' : '××¡×•×¨ ×©×™×”×™×” ×‘×§×‘×•×¦×” ×¢×'}</label>
                            <div class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                                ${otherStudents.map(s => `
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" value="${s.id}" ${student.constraints.dontSitWith.includes(s.id) ? 'checked' : ''} 
                                               class="constraint-checkbox mr-2" data-key="dontSitWith" />
                                        <span>${s.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <p class="text-xs text-slate-500 mt-1">× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×ª×œ××™×“×™×</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-3 space-x-reverse">
                <button id="cancel-student-edit" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">×‘×™×˜×•×œ</button>
                <button id="save-student-edit" class="py-2 px-4 bg-sky-500 text-white rounded-md hover:bg-sky-600">×©××™×¨×”</button>
            </div>
        </div>
    </div>`;
}

function ResultScreen() {
    const activeChart = getActiveChart();
    console.log("ResultScreen - activeChart:", activeChart);
    
    if (!activeChart || !activeChart.generatedLayout) {
        console.log("No chart or no generated layout");
        return `<div class="text-center p-8">
            <p class="text-lg text-slate-600">××™×Ÿ ××¤×” ×œ×”×¦×’×”</p>
        </div>`;
    }
    
    console.log("Layout type:", activeChart.layoutType);
    console.log("Generated layout:", activeChart.generatedLayout);
    
    if (activeChart.layoutType === 'rows') {
        console.log("Showing classroom grid");
        return ClassroomGrid(activeChart);
    } else {
        console.log("Showing group display");
        return GroupDisplay(activeChart);
    }
}

function ClassroomGrid(chart) {
    const layout = chart.layoutDetails;
    const { generatedLayout } = chart;
    const { teacherDeskPosition, windowPosition, doorPosition, cols, rows } = layout;

    const teacherDesk = `<div class="bg-slate-700 text-white flex items-center justify-center rounded-lg shadow-lg text-xl font-bold" style="width: 200px; height: 70px;">×©×•×œ×—×Ÿ ××•×¨×”</div>`;
    const door = `<div class="flex flex-col items-center text-slate-600 text-lg font-medium">${DoorIcon({className: 'h-12 w-12 mb-1'})}<span>×“×œ×ª</span></div>`;
    const windowEl = `<div class="flex flex-col items-center text-slate-600 text-lg font-medium">${WindowIcon({className: 'h-12 w-12 mb-1'})}<span>×—×œ×•×Ÿ</span></div>`;
    
    const sideItems = `<div class="flex justify-center items-center space-x-6 space-x-reverse">
        <div class="flex items-center space-x-4 space-x-reverse">${doorPosition === 'right' ? door : ''} ${windowPosition === 'right' ? windowEl : ''}</div>
        ${teacherDesk}
        <div class="flex items-center space-x-4 space-x-reverse">${doorPosition === 'left' ? door : ''} ${windowPosition === 'left' ? windowEl : ''}</div>
    </div>`;

    const getStudentData = (name) => name ? chart.students.find(s => s.name === name) : null;
    const renderStudent = (studentData) => {
        const student = getStudentData(studentData?.name);
        return `<div class="w-full h-full flex flex-col items-center justify-center p-1">
            ${student ? `
                ${student.picture ? `<img src="${student.picture}" alt="${student.name}" class="student-picture w-12 h-12 rounded-full object-cover mb-1 border-2 border-gray-300"/>` : `<div class="student-picture w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center mb-1 border-2 border-gray-300">${UserIcon({className: 'w-7 h-7 text-gray-500'})}</div>`}
                <span class="student-name text-slate-800 text-xs font-medium text-center break-words leading-tight">${student.name}</span>`
            : `<div class="w-12 h-12 rounded-full bg-sky-200/50 mb-1"></div>`}
        </div>`;
    };

    let gridHTML = '';
    const allVisualRows = Array.from({ length: rows }, (_, i) => i + 1);

    for (const visualRow of allVisualRows) {
        let dataRow, rowLabel;
        if (teacherDeskPosition === 'bottom') {
            dataRow = rows - visualRow + 1;
            rowLabel = dataRow;
        } else {
            dataRow = visualRow;
            rowLabel = visualRow;
        }

        let rowContent = `<div class="row-label text-center font-bold text-slate-700 text-lg flex items-center justify-center min-w-20" style="margin-bottom: 10px;">×©×•×¨×” ${rowLabel}</div>`;
        for (let colIndex = 0; colIndex < cols; colIndex++) {
            const col = colIndex + 1;
            const desk = generatedLayout?.desks?.find(d => d.row === dataRow && d.col === col);
            const student1 = desk?.students.find(s => s.seat === 1);
            const student2 = desk?.students.find(s => s.seat === 2);
            rowContent += `
                <div class="desk-container bg-white rounded-lg shadow-lg border-2 border-sky-400 overflow-hidden relative" style="width: 145px; height: 80px; margin-bottom: 10px;">
                    <div class="seat-number absolute top-1 right-1 bg-sky-500 text-white text-xs font-bold rounded px-1 py-0.5 z-10">1</div>
                    <div class="seat-number absolute top-1 left-1 bg-sky-500 text-white text-xs font-bold rounded px-1 py-0.5 z-10">2</div>
                    <div class="flex h-full">
                        <div class="w-1/2 border-l border-sky-300">${renderStudent(student1)}</div>
                        <div class="w-1/2">${renderStudent(student2)}</div>
                    </div>
                </div>`;
        }
        gridHTML += rowContent;
    }

    return `
        <div id="result-screen-container" class="w-full overflow-auto bg-gray-100 p-4">
            <div id="printable-area" class="bg-white mx-auto shadow-lg p-6" style="max-width: 1200px;">
                <div class="text-center mb-2" style="margin-top: -30px;">
                    <h1 class="text-4xl font-bold text-slate-800 mb-2">${chart.className}</h1>
                    <h2 class="text-2xl text-slate-600">${new Date(chart.creationDate).toLocaleDateString('he-IL', { timeZone: 'UTC' })}</h2>
                </div>
                
                <div class="flex flex-col items-center">
                    ${teacherDeskPosition === 'top' ? `<div class="teacher-desk-area mb-2 w-full flex justify-center" style="margin-top: -20px;">${sideItems}</div>` : ''}
                    
                    <div class="w-full flex justify-center">
                        <div class="classroom-grid inline-grid" style="grid-template-columns: auto 145px 145px 145px 145px; align-items: start; justify-items: center; margin-top: -20px; column-gap: 12px; row-gap: 0px;">
                            <div></div>
                            ${Array.from({ length: cols }).map((_, i) => `<div class="column-header text-center font-bold text-slate-700 text-lg" style="margin-bottom: -5px;">×˜×•×¨ ${i + 1}</div>`).join('')}
                            ${gridHTML}
                        </div>
                    </div>
                    
                    ${teacherDeskPosition === 'bottom' ? `<div class="teacher-desk-area mt-2 w-full flex justify-center">${sideItems}</div>` : ''}
                </div>
                
                ${generatedLayout?.unplacedStudents && generatedLayout.unplacedStudents.length > 0 ? `
                    <div class="unplaced-students mt-6 text-center">
                        <h3 class="text-xl font-bold text-rose-600 mb-2">×ª×œ××™×“×™× ×©×œ× ×©×•×‘×¦×•:</h3>
                        <p class="text-lg text-slate-700">${generatedLayout.unplacedStudents.join(', ')}</p>
                    </div>` : ''}
            </div>
        </div>`;
}

function GroupDisplay(chart) {
    console.log("GroupDisplay called with chart:", chart);
    
    const { generatedLayout } = chart;
    console.log("Generated layout in GroupDisplay:", generatedLayout);
    
    if (!generatedLayout || !generatedLayout.groups) {
        console.log("No groups found in generated layout");
        return `<div class="text-center p-8">
            <p class="text-lg text-red-600">×©×’×™××”: ×œ× × ××¦××• ×§×‘×•×¦×•×ª</p>
        </div>`;
    }
    
    const getStudentData = (name) => chart.students.find(s => s.name === name);
    const groupColors = ['border-sky-400', 'border-teal-400', 'border-amber-400', 'border-rose-400', 'border-indigo-400'];

    return `
         <div id="result-screen-container" class="w-full max-w-7xl mx-auto">
             <div id="printable-area" class="p-6 bg-white rounded-lg shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-slate-800">${chart.className}</h1>
                    <h2 class="text-xl text-slate-500">${new Date(chart.creationDate).toLocaleDateString('he-IL', { timeZone: 'UTC' })}</h2>
                </div>
                <div class="groups-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${generatedLayout.groups.sort((a,b) => a.groupNumber - b.groupNumber).map(group => `
                        <div class="group-card bg-white rounded-lg shadow-md p-6 border-t-4 ${groupColors[(group.groupNumber - 1) % groupColors.length]}">
                            <h3 class="text-2xl font-bold mb-4 text-slate-700">×§×‘×•×¦×” ${group.groupNumber}</h3>
                            <ul class="space-y-3">
                                ${group.students.map(name => {
                                    const student = getStudentData(name);
                                    return `<li class="flex items-center bg-slate-50 p-3 rounded-md shadow-sm">
                                        ${student?.picture ? `<img src="${student.picture}" alt="${name}" class="w-12 h-12 rounded-full object-cover mr-3"/>` : `<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center mr-3 flex-shrink-0">${UserIcon({className: 'w-7 h-7 text-gray-500'})}</div>`}
                                        <span class="text-slate-800 font-medium text-lg">${name}</span>
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
                ${generatedLayout.unplacedStudents && generatedLayout.unplacedStudents.length > 0 ? `
                    <div class="unplaced-students mt-8">
                        <h3 class="text-xl font-bold text-rose-600 text-center">×ª×œ××™×“×™× ×©×œ× ×©×•×‘×¦×•:</h3>
                        <p class="text-center text-slate-700">${generatedLayout.unplacedStudents.join(', ')}</p>
                    </div>` : ''}
            </div>
        </div>
    `;
}

function LoadingScreen() {
    return `<div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-sky-500 mx-auto"></div>
        <h2 class="text-2xl font-bold text-slate-700 mt-6">×™×•×¦×¨ ×¡×™×“×•×¨ ×—×›×...</h2>
        <p class="text-slate-500">${API_KEY ? '×”×‘×™× ×” ×”××œ××›×•×ª×™×ª ×¢×•×‘×“×ª ×¢×œ ×”××¤×” ×”××•×¤×˜×™××œ×™×ª ×¢×‘×•×¨×›×.' : '×™×•×¦×¨ ××¤×ª ×™×©×™×‘×” ××§×¨××™×ª ××•×ª×××ª.'} ×–×” ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×¨×’×¢×™×.</p>
    </div>`;
}

// =================================================================
//  EVENT HANDLERS & LOGIC
// =================================================================

function handleLogin(e) {
    e.preventDefault();
    const name = document.getElementById('teacherName').value.trim();
    if (name) {
        if (!state.allUsers.includes(name)) {
            state.allUsers.push(name);
        }
        state.currentUser = name;
        state.currentScreen = 'main';
        
        // Clear ALL session data when logging in as different user
        state.studentListInput = '';
        state.studentAddMode = 'single';
        state.studentToEdit = null;
        state.isCreateModalOpen = false;
        state.isEmbedModalOpen = false;
        state.openClass = null;
        resetHistory(null);
        
        renderApp();
    }
}

function handleLogout() {
    state.currentUser = null;
    renderApp();
}

function startNewChart(e) {
    e.preventDefault();
    const className = document.getElementById('className').value.trim();
    const dateString = document.getElementById('chartDate').value;
    
    if (className && dateString) {
        const charts = state.allCharts[state.currentUser] || [];
        const existingChartsForClass = charts
            .filter(c => c.className === className)
            .sort((a, b) => new Date(b.creationDate).getTime() - new Date(a.creationDate).getTime());
        
        const [year, month, day] = dateString.split('-').map(Number);
        const selectedDate = new Date(Date.UTC(year, month - 1, day));
        
        const newName = selectedDate.toLocaleDateString('he-IL', { timeZone: 'UTC' });
        const newCreationDate = selectedDate.toISOString();

        // DON'T copy students from previous charts - start fresh!
        const newChart = {
            id: generateId(),
            name: newName,
            className: className,
            creationDate: newCreationDate,
            layoutType: 'rows',
            layoutDetails: {...DEFAULT_ROWS_LAYOUT},
            students: [], // Always start with empty students array
        };
        
        // Clear any previous input data
        state.studentListInput = '';
        state.studentAddMode = 'single';
        
        resetHistory(newChart);
        state.currentScreen = 'setup';
        state.isCreateModalOpen = false;
        renderApp();
    }
}

function loadChart(chartId) {
    const charts = state.allCharts[state.currentUser] || [];
    const chartToLoad = charts.find(c => c.id === chartId);
    if (chartToLoad) {
        resetHistory(chartToLoad);
        state.currentScreen = chartToLoad.generatedLayout ? 'result' : 'setup';
        renderApp();
    }
}

function deleteChart(chartId) {
    let charts = state.allCharts[state.currentUser] || [];
    charts = charts.filter(c => c.id !== chartId);
    state.allCharts[state.currentUser] = charts;
    renderApp();
}

function deleteClass(className) {
    if (!state.currentUser) return;
    
    if (window.confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”××¤×•×ª ×©×œ ×›×™×ª×” "${className}"? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ×¤×¢×•×œ×” ×–×•.`)) {
        let charts = state.allCharts[state.currentUser] || [];
        charts = charts.filter(c => c.className !== className);
        state.allCharts[state.currentUser] = charts;
        
        // If this was the open class, close it
        if (state.openClass === className) {
            state.openClass = null;
        }
        
        renderApp();
    }
}

function clearCurrentUserData() {
    if (!state.currentUser) return;
    if (window.confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ ${state.currentUser}? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ×¤×¢×•×œ×” ×–×•.`)) {
        state.allCharts[state.currentUser] = [];
        renderApp();
    }
}

function addStudent(e) {
    e.preventDefault();
    const input = e.target.elements.studentName;
    const name = input.value.trim();
    const activeChart = getActiveChart();

    if (name && activeChart && !activeChart.students.some(s => s.name === name)) {
        const newStudent = { id: generateId(), name, picture: undefined, constraints: {...DEFAULT_STUDENT_CONSTRAINTS} };
        setActiveChart(prev => ({...prev, students: [...prev.students, newStudent]}));
        state.studentListInput = '';
        renderApp();
    }
    input.value = '';
}

function addStudentsFromList(e) {
    e.preventDefault();
    const activeChart = getActiveChart();
    if (!state.studentListInput.trim() || !activeChart) return;

    let text = state.studentListInput.trim();
    let names = [];

    // Method 1: Try splitting by actual line breaks first
    names = text.split(/\r?\n/).filter(name => name.trim().length > 0);
    
    // Method 2: If we only have one item, it's probably all on one line - split by spaces
    if (names.length === 1) {
        names = text.split(/\s+/).filter(name => name.trim().length > 0);
    }
    
    // Clean up the names
    names = names.map(name => name.trim()).filter(name => name.length > 0);

    console.log("Text input:", text);
    console.log("Names after processing:", names);

    const existingNames = new Set(activeChart.students.map(s => s.name));
    const newStudents = names
        .filter(name => !existingNames.has(name))
        .map(name => ({ id: generateId(), name, picture: undefined, constraints: {...DEFAULT_STUDENT_CONSTRAINTS} }));

    console.log("New students to add:", newStudents);

    if (newStudents.length > 0) {
        setActiveChart(prev => ({...prev, students: [...prev.students, ...newStudents]}));
    }
    
    state.studentListInput = '';
    renderApp();
}

function updateStudent() {
    // Simple and direct update
    setActiveChart(prev => ({ 
        ...prev, 
        students: prev.students.map(s => 
            s.id === state.studentToEdit.id ? {...state.studentToEdit} : s
        ) 
    }));
    state.studentToEdit = null;
    renderApp();
}

function saveCurrentChart() {
    const chart = getActiveChart();
    if (chart && state.currentUser) {
        const charts = state.allCharts[state.currentUser] || [];
        const existingIndex = charts.findIndex(c => c.id === chart.id);
        if (existingIndex > -1) {
            charts[existingIndex] = chart;
        } else {
            charts.push(chart);
        }
        state.allCharts[state.currentUser] = charts;
        saveToLocalStorage('seatingApp_allCharts', state.allCharts);
    }
}

async function handleGenerateChart() {
    const activeChart = getActiveChart();
    if (!activeChart) {
        console.error("No active chart found!");
        return;
    }
    
    console.log("Starting chart generation for:", activeChart.layoutType);
    console.log("Active chart:", activeChart);
    
    state.currentScreen = 'loading';
    renderApp();

    try {
        console.log("Calling generateLayout...");
        const result = await generateLayout(activeChart);
        console.log("generateLayout returned:", result);
        
        setActiveChart(prev => ({ ...prev, generatedLayout: result }));
        saveCurrentChart();
        state.currentScreen = 'result';
        console.log("Chart generation completed successfully");
    } catch (error) {
        console.error("Error in handleGenerateChart:", error);
        alert("××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×™×¦×™×¨×ª ×”××¤×”. × ×¡×• ×©×•×‘.");
        state.currentScreen = 'students';
    }
    renderApp();
}

// =================================================================
//  EVENT LISTENERS & MAIN RENDER
// =================================================================
function attachEventListeners() {
    root.removeEventListener('click', handleClick);
    root.removeEventListener('submit', handleSubmit);
    root.removeEventListener('input', handleInput);
    root.removeEventListener('change', handleChange);
    
    root.addEventListener('click', handleClick);
    root.addEventListener('submit', handleSubmit);
    root.addEventListener('input', handleInput);
    root.addEventListener('change', handleChange);
}

function handleClick(e) {
    console.log("Click detected on:", e.target);
    
    const target = e.target.closest('[id], [data-id], [data-screen], [data-mode], [data-classname]');
    if (!target) return;
    
    console.log("Target element:", target, "ID:", target.id);

    // Global
    if (target.id === 'logout-btn') handleLogout();
    if (target.id === 'save-and-exit-btn') {
        saveCurrentChart();
        state.currentScreen = 'main';
        resetHistory(null);
        renderApp();
    }
    if (target.id === 'undo-btn') undo();
    if (target.id === 'redo-btn') redo();
    if (target.id === 'print-btn') window.print();
    if (target.id === 'regenerate-btn') handleGenerateChart();
    if (target.matches('.screen-nav-btn')) {
        state.currentScreen = target.dataset.screen;
        renderApp();
    }

    // Main Screen
    if (target.id === 'start-new-chart-btn') { state.isCreateModalOpen = true; renderApp(); }
    if (target.id === 'clear-data-btn') clearCurrentUserData();
    if (target.matches('.load-chart-btn')) loadChart(target.dataset.id);
    if (target.matches('.delete-chart-btn')) deleteChart(target.dataset.id);
    if (target.matches('.delete-class-btn')) deleteClass(target.dataset.classname);
    if (target.matches('.toggle-class-btn')) {
        const className = target.dataset.classname;
        state.openClass = state.openClass === className ? null : className;
        renderApp();
    }

    // Modals
    if (target.id === 'close-modal-btn' || (target.id === 'create-chart-modal' && !target.querySelector('div'))) {
        state.isCreateModalOpen = false; renderApp();
    }
    if (target.id === 'cancel-student-edit' || (target.id === 'student-modal-container' && !target.querySelector('div'))) {
        state.studentToEdit = null; renderApp();
    }
    if (target.id === 'save-student-edit') updateStudent();

    // Setup Screen
    if (target.matches('.layout-type-btn')) {
        const type = target.dataset.type;
        console.log("Layout type button clicked:", type);
        
        setActiveChart(prev => {
            const updated = {
                ...prev,
                layoutType: type,
                layoutDetails: type === 'rows' ? {...DEFAULT_ROWS_LAYOUT} : {...DEFAULT_GROUPS_LAYOUT}
            };
            console.log("Updated chart with new layout type:", updated);
            return updated;
        });
        renderApp();
    }

    // Student Screen
    if (target.matches('.add-mode-btn')) { 
        state.studentAddMode = target.dataset.mode; 
        // Clear the input when switching modes
        state.studentListInput = '';
        renderApp(); 
    }
    if (target.matches('.edit-student-btn')) {
        const student = getActiveChart().students.find(s => s.id === target.dataset.id);
        state.studentToEdit = student ? JSON.parse(JSON.stringify(student)) : null;
        renderApp();
    }
    if (target.matches('.remove-student-btn')) {
        setActiveChart(prev => ({ ...prev, students: prev.students.filter(s => s.id !== target.dataset.id) }));
        renderApp();
    }
    if (target.id === 'generate-chart-btn') {
        console.log("Generate chart button clicked!");
        const activeChart = getActiveChart();
        console.log("Active chart on button click:", activeChart);
        if (activeChart) {
            console.log("Chart layout type:", activeChart.layoutType);
            console.log("Students count:", activeChart.students.length);
        }
        handleGenerateChart();
    }
}

function handleSubmit(e) {
    if (e.target.id === 'login-form') handleLogin(e);
    if (e.target.id === 'create-chart-form') startNewChart(e);
    if (e.target.id === 'add-student-form') addStudent(e);
    if (e.target.id === 'add-student-list-form') addStudentsFromList(e);
}

function handleInput(e) {
    const target = e.target;
    // Setup Screen
    if (target.matches('.layout-details-input')) {
        const key = target.dataset.key;
        const value = target.type === 'number' ? parseInt(target.value) || 0 : target.value;
        setActiveChart(prev => ({ ...prev, layoutDetails: { ...prev.layoutDetails, [key]: value } }));
    }
    if(target.id === 'student-list-input') {
        state.studentListInput = target.value;
    }
}

function handleChange(e) {
    const target = e.target;
    if (target.matches('.chart-update-input') && target.dataset.key === 'creationDate') {
        if (!target.value) return;
        const [year, month, day] = target.value.split('-').map(Number);
        const selectedDate = new Date(Date.UTC(year, month - 1, day));
        setActiveChart(prev => ({ ...prev, creationDate: selectedDate.toISOString() }));
    }
    
    // Student Modal
    if (!state.studentToEdit) return;
    if (target.id === 'picture-upload' && target.files && target.files[0]) {
        const reader = new FileReader();
        reader.onload = (event) => {
            state.studentToEdit.picture = event.target.result;
            renderApp();
        };
        reader.readAsDataURL(target.files[0]);
    }
    if (target.matches('.constraint-input')) {
        const key = target.dataset.key;
        let value;
        if (target.type === 'checkbox') {
            value = target.checked;
        } else if (target.multiple) {
            value = Array.from(target.selectedOptions, option => option.value);
        } else {
            value = target.value;
        }
        state.studentToEdit.constraints[key] = value;
    }
    if (target.matches('.constraint-checkbox')) {
        const key = target.dataset.key;
        const studentId = target.value;
        const isChecked = target.checked;
        
        if (!state.studentToEdit.constraints[key]) {
            state.studentToEdit.constraints[key] = [];
        }
        
        if (isChecked) {
            // Add student ID if not already present
            if (!state.studentToEdit.constraints[key].includes(studentId)) {
                state.studentToEdit.constraints[key].push(studentId);
            }
        } else {
            // Remove student ID
            state.studentToEdit.constraints[key] = state.studentToEdit.constraints[key].filter(id => id !== studentId);
        }
    }
    if (target.id === 'fixed-position-toggle') {
        state.studentToEdit.constraints.fixedPosition = target.checked ? { row: 1, col: 1, seat: 1 } : null;
        renderApp();
    }
    if (target.matches('.fixed-pos-input')) {
        const key = target.dataset.key;
        const value = parseInt(target.value);
        state.studentToEdit.constraints.fixedPosition[key] = value;
    }
}

function renderApp() {
    // Persist state
    saveToLocalStorage('seatingApp_allUsers', state.allUsers);
    saveToLocalStorage('seatingApp_allCharts', state.allCharts);

    let headerHTML = '';
    let contentHTML = '';

    if (state.isEmbedView) {
        root.innerHTML = AppShell('', ResultScreen());
        return;
    }
    
    if (!state.currentUser) {
        root.innerHTML = LoginScreen();
        return;
    }
    
    const showMainHeader = state.currentScreen === 'main';
    const showEditorHeader = ['setup', 'students', 'result'].includes(state.currentScreen);

    if (showMainHeader) headerHTML = MainHeader();
    if (showEditorHeader) headerHTML = EditorHeader();

    switch (state.currentScreen) {
        case 'main': contentHTML = MainScreen(); break;
        case 'setup': contentHTML = SetupScreen(); break;
        case 'students': contentHTML = StudentScreen(); break;
        case 'result': contentHTML = ResultScreen(); break;
        case 'loading': contentHTML = LoadingScreen(); break;
        default: contentHTML = MainScreen();
    }
    
    const modalHTML = CreateChartModal() + StudentModal();
    root.innerHTML = AppShell(headerHTML, contentHTML) + modalHTML;
}

function init() {
    state.allUsers = getFromLocalStorage('seatingApp_allUsers', []);
    state.allCharts = getFromLocalStorage('seatingApp_allCharts', {});
    attachEventListeners();
    renderApp();
}

document.addEventListener('DOMContentLoaded', init);

</script>
  </body>
</html> 